#----- This should be called before anything else, don't define stuff before this line. ---#
rm(list=ls())
graphics.off()
#------------------------------------------------------------------------------------------#


#----- The user-defined variable section. -------------------------------------------------#
main             = "pathhere"
histomain        = "pathhere"
srcdir           = "thisrscpath"
polyg            = "thispoly"
queue            = "thisqueue"
yeara            = thisyeara
montha           = thismontha
datea            = thisdatea
timea            = thistimea
yearz            = thisyearz
monthz           = thismonthz
datez            = thisdatez
timez            = thistimez
lon              = thislon
lat              = thislat
#------------------------------------------------------------------------------------------#


#----- List periods. ----------------------------------------------------------------------#
n           = 0
period      = list()
n           = n + 1
period[[n]] = list( todaya = "01/01/2003"
                  , todayz = "12/31/2010"
                  , times  = c("01:30:00","13:30:00")
                  )#end list
n           = n + 1
period[[n]] = list( todaya = "01/01/2011"
                  , todayz = "12/31/2018"
                  , times  = c("06:00:00","18:00:00")
                  )#end list
#------------------------------------------------------------------------------------------#


#------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------#
#   No need to change anything beyond this point unless you are developing the script.     #
#------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------#






#==========================================================================================#
#==========================================================================================#
#      Function that converts a chron object to numeric years.                             #
#------------------------------------------------------------------------------------------#
numyears <<- function(when){
   yrs    = years(when)
   lyrs   = levels(yrs)
   yrout  = as.numeric(lyrs[match(yrs,lyrs)])
   return(yrout)
}#end function
#==========================================================================================#
#==========================================================================================#






#==========================================================================================#
#==========================================================================================#
#      Function that converts a chron object to numeric months.                            #
#------------------------------------------------------------------------------------------#
nummonths <<- function(when){
   mos    = months(when)
   lmos   = levels(mos)
   moout  = match(mos,lmos)
   return(moout)
}#end function
#==========================================================================================#
#==========================================================================================#






#==========================================================================================#
#==========================================================================================#
#      Function that converts a chron object to numeric days.                              #
#------------------------------------------------------------------------------------------#
numdays <<- function(when){
   dys    = days(when)
   ldys   = levels(dys)
   dyout  = match(dys,ldys)
   return(dyout)
} #end function
#==========================================================================================#
#==========================================================================================#


#----- Output path. -----------------------------------------------------------------------#
output           = file.path(main,polyg)
#------------------------------------------------------------------------------------------#


#----- Load some useful scripts and packages. ---------------------------------------------#
isok = require(chron)
isok = require(data.table)
#------------------------------------------------------------------------------------------#



#----- Find the standard output files. ----------------------------------------------------#
whena = chron(paste(montha,datea,yeara,sep="/"))
whenz = chron(paste(monthz,datez,yearz,sep="/"))
#------------------------------------------------------------------------------------------#


#----- Find the time offset, and round it to the nearest half-hour. -----------------------#
offutc = round( 2. * lon / 15.) / 2.
#------------------------------------------------------------------------------------------#


#----- Find number of periods. ------------------------------------------------------------#
nperiod = length(period)
#------------------------------------------------------------------------------------------#



#------------------------------------------------------------------------------------------#
#     Expand the times for all days.                                                       #
#------------------------------------------------------------------------------------------#
when = NULL
for (p in sequence(nperiod)){
   #----- Current period. -----------------------------------------------------------------#
   todaya = chron(period[[p]]$todaya)
   todayz = chron(period[[p]]$todayz)
   times  = period[[p]]$times
   #---------------------------------------------------------------------------------------#


   #------ List of dates and times. -------------------------------------------------------#
   today  = chron(seq(from=as.numeric(todaya),to=as.numeric(todayz),by=1))
   ntoday = length(today)
   ntimes = length(times)
   #---------------------------------------------------------------------------------------#


   #------- Append times from this period. ------------------------------------------------#
   when.now = chron(rep(today,each=ntimes),rep(times,times=ntoday)) + offutc / 24
   when.now = when.now[(when.now >= whena) & (when.now <= whenz)]
   #---------------------------------------------------------------------------------------#

   #------ Append time. -------------------------------------------------------------------#
   when = chron(c(when,when.now))
   #---------------------------------------------------------------------------------------#
}#end for (p in sequence(nperiod))
#------------------------------------------------------------------------------------------#




#----- Write the data sets. ---------------------------------------------------------------#
datum = data.table( Year             = sprintf("%4.4i",numyears (when))
                  , Month            = sprintf("%2.2i",nummonths(when))
                  , Date             = sprintf("%2.2i",numdays  (when))
                  , Hour             = sprintf("%2.2i",hours    (when))
                  , Minute           = sprintf("%2.2i",minutes  (when))
                  , Second           = sprintf("%2.2i",seconds  (when))
                  , stringsAsFactors = FALSE
                  )#end data.table
#------------------------------------------------------------------------------------------#




#----- Write observation times. -----------------------------------------------------------#
obstab = file.path(main,polyg,paste0(polyg,"_obstimes.txt"))
dummy  = write.table( x         = format(datum)
                    , file      = obstab
                    , append    = FALSE
                    , quote     = FALSE
                    , row.names = FALSE
                    , col.names = TRUE
                    )#end write.table
#------------------------------------------------------------------------------------------#
